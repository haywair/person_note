### 动静分离

---

动态数据和静态数据的主要区别就是看页面中输出的 数据是否和url、浏览者、时间、地域相关，以及是否含有cookie等私密数据。

* 怎样对静态数据做缓存?
  1. 把静态数据缓存到离用户最近的地方。静态数据就是那些相对不会发生变化的数据。常见的有三种 <u>**用户浏览器里**</u> 、<u>**CDN上**</u> 、<u>**服务端的Cache**</u> 中。根据情况缓存到离用户最近的 地方
  2. 静态化改造是直接缓存 HTTP 链接。web代理服务器根据请求url,直接去除对应的http响应头和响应体直接返回。

![img](https://static001.geekbang.org/resource/image/2c/46/2c608715621afc9c95570dce00a87546.jpg)

 	3. 让谁来做缓存静态数据也很重要。不同语言写的cache 软件处理缓存数据效率也各不相同。例如Java层、web服务器层选择web服务器做大并发的静态文件请求。

---

* 怎样做动静分离的改造：

  1. url 唯一化。例如商品详情系统天然的做到了url 统一化，以商品的 id 作为 key 值

  2. 分离浏览者相关的因素。包括是否已登录、登录身份等，可以单独拆分出来，通过动态请求获取 
  3. 分离时间因素。 服务端输出的时间也通过 动态请求获取
  4. 异步化地域因素。详情页面上与地域相关的因素做成异步方式获取。
  5. 去掉Cookie。在缓存的静态数据中不含有Cookie

---

* 缓存方式处理静态数据的方案 ESI 方案、CSI方案
  1. ESI方案（或者SSI）: 即在Web代理服务器上做动态内容请求，并将请求插入到静态页面中，当用户拿到页面时已经是 一个完整的页面了。这种方式对服务端性能有影响，但是用户体验较好。
  2. CSI方案。即单独发起一个异步javascript请求，以向 服务端后去动态 内容。这种服务端性能更佳，但是用户端页面可能会延时，体验稍差。

---

* 动静分离的几种架构方案

  1. 实体机单机部署

     ![img](https://static001.geekbang.org/resource/image/4e/8a/4e4f0b0e5b83deaccb8cc49ad40f1a8a.jpg)





     优点： 没有网络瓶颈，而且能使用大内存。既能提升命中率，又能减少gzip压缩，减少Cache失效压力，采用定时失效方式，过期即自动失效。

     确点：一个实体机上即部署了 java应用又作为Cache应用，增加了运维的高复杂度。而且增加单机的内存容量，一定程度上也造成了cpu的浪费

  2. 统一 Cache 层

     所谓统一的cache层，就是将单机的 Cache 统一分离出来，形成一个单独的 cache 集群。统一cache层是更理想的可推广方案。

     ![img](https://static001.geekbang.org/resource/image/36/d2/36af87e321f9d6a2f4516bf2e21e55d2.jpg)



     优点：单独一个cache层，可以减少多个应用接入时使用cache的成本。统一cache的方案更易于维护，可以共享内存，最大化利用内存。

     缺点：cache层内部交互网络成为瓶颈，缓存服务器的网卡也会是瓶颈，机器少风险大，挂掉一台就会影响很大一部分缓存数据。

  3. 上 CDN

     缺点：失效问题。同时失效难度较大。 命中率低。发布更新问题。还要考虑有问题时快速回滚和排查问题的简便性



     选择 CDN 的二级 Cache 比较合适，因为二级 Cache数量偏少，容量也更大，让用户的请求先回源cdn 的二级Cache中，如果没命中再回原站获取数据。


![img](https://static001.geekbang.org/resource/image/c0/dd/c0fd22cf9d565a8ea2e9edcefae3b2dd.jpg)

----

QA:

方案一和方案二中静态页面和动态资源的组装完整页面是在服务端吗？

** 作者回复

理论上都可以，各有优缺点，秒杀推荐在客户端做，普通的商品推荐在服务端做